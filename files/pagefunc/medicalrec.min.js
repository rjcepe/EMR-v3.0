var token=sessionStorage.getItem("accstoken");null===token&&(window.location.href="../index.html");const SUPABASE_URL="https://yspyqlodogzmrqsifbww.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzcHlxbG9kb2d6bXJxc2lmYnd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTgwOTMxNTYsImV4cCI6MjAxMzY2OTE1Nn0.YjQ-8W-UKbg5JPOO0q3aWT2eXjXe593IlxhkZVSAqkk",_supabase=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);async function loadTableData(){var e=document.getElementById("sort1").value,{data:t,error:a}=await _supabase.from("med_forms").select("*");if(a)console.log("Error loading table data:",a.message);else{const o=document.querySelector("#medform_table tbody");o.innerHTML="",0===t.length?((a=document.createElement("tr")).innerHTML='<th class="row" colspan="7">No data available</td>',o.appendChild(a),console.log("No data")):("ID"===e?t.sort((e,t)=>new Date(e.patient_id)-new Date(t.patient_id)):"TimeLate"===e?t.sort((e,t)=>new Date(t.row_id)-new Date(e.row_id)):"TimeOld"===e?t.sort((e,t)=>new Date(e.row_id)-new Date(t.row_id)):"def"===e?t.sort((e,t)=>new Date(t.row_id)-new Date(e.row_id)):"Nameaz"===e?t.sort((e,t)=>e.patient_name.toString().localeCompare(t.patient_name)):"Nameza"===e?t.sort((e,t)=>t.patient_name.toString().localeCompare(e.patient_name)):"CS"===e?t.sort((e,t)=>e.course_section.toString().localeCompare(t.course_section)):"EMP"===e&&t.sort((e,t)=>t.course_section.toString().localeCompare(e.course_section)),t.forEach(e=>{var t=document.createElement("tr");t.classList.add("res"),t.innerHTML=`
          <th class="row idcol">${e.patient_id}</th>
          <th class="row namecol">${e.patient_name}</th>
          <th class="row timecol">${e.created_date}</th>
          <th class="row coursecol">${e.course_section}</th>
          <th class="row timecol">${e.location}</th>
          <th class="row timecol">${e.added_by}</th>
          <th class="buttscol">
            <button class="viewbutt" onclick="showv('${e.med_file}', '${e.patient_name}')">
              <p class="txt">View</p>
            </button>
          </th>
        `,o.appendChild(t)}))}}async function getusername(){var e=localStorage.getItem("uid1"),{data:e,error:t}=await _supabase.from("user_accs").select("username").eq("id",e);t?console.error("Error fetching username:",t.message):e&&0<e.length?getusername1(e[0].username):console.log("User not found with ID:",id)}function getusername1(e){localStorage.setItem("x",e)}async function fetchUsername(){var e=localStorage.getItem("uid1"),{data:t,error:a}=await _supabase.from("user_accs").select("username").eq("id",e);a?console.error("Error fetching username:",a.message):t&&0<t.length?(a=t[0].username,(t=document.querySelector(".username"))?((h4=document.createElement("h4")).innerHTML=a,(h6=document.createElement("h6")).innerHTML=e,t.appendChild(h4),t.appendChild(h6)):console.error("Element with class 'vfile' not found.")):console.log("User not found with ID:",id)}async function fetchUserPic(){var e=localStorage.getItem("uid1")+".png",e=SUPABASE_URL+"/storage/v1/object/public/userimages/"+e,t=document.querySelector(".user"),a=document.querySelector(".username"),o=document.createElement("img");o.setAttribute("src",e),t.insertBefore(o,a)}loadTableData(),document.getElementById("sort1").addEventListener("change",function(){loadTableData()}),getusername(),$("#insertstudmedform").submit(async function(e){e.preventDefault();let t=localStorage.getItem("studmedfilecount");t=null===t?0:parseInt(t);var e=$("#studname").val(),a=$("#studid").val(),o=$("#studcs").val(),r=$("#locsel").val(),n=localStorage.getItem("x"),s=document.getElementById("medform").files[0];t++,localStorage.setItem("studmedfilecount",t);try{var l,i,c,d,m,u,p=`${a}_medform${t}.`+s.name.split(".").pop(),h=(await _supabase.storage.from("medicalrecords").upload(p,s))["error"];h?(console.error("Error uploading file:",h),alert("Error uploading file:",h)):(l=SUPABASE_URL+"/storage/v1/object/public/medicalrecords/"+p,i="Asia/Manila",d={patient_id:a,patient_name:e,created_date:(c=new Date).toLocaleString("en-US",{timeZone:i,year:"numeric"})+`-${c.toLocaleString("en-US",{timeZone:i,month:"2-digit"})}-`+c.toLocaleString("en-US",{timeZone:i,day:"2-digit"}),course_section:o,location:r,added_by:n,med_file:l},{data:m,error:u}=await _supabase.from("med_forms").insert(d),u?(console.error("Error inserting data:",u.message),alert("Error inserting data")):(console.log("Data inserted successfully:",m),loadTableData(),hidep(),shownotif(),$("#studname").val(""),$("#studid").val(""),$("#studcs").val(""),$("#locsel").val(""),$("#medform").val("")))}catch(e){console.error("Error:",e.message),alert("Error, invalid input")}}),$("#insertempmedform").submit(async function(e){e.preventDefault();let t=localStorage.getItem("empmedfilecount");t=null===t?0:parseInt(t);var e=$("#empname").val(),a=$("#empid").val(),o=$("#locsel1").val(),r=localStorage.getItem("x"),n=document.getElementById("medform2").files[0];t++,localStorage.setItem("empmedfilecount",t);try{var s,l,i,c,d,m,u=`${a}_medform${t}.`+n.name.split(".").pop(),p=(await _supabase.storage.from("medicalrecords").upload(u,n))["error"];p?(console.error("Error uploading file:",p),alert("Error uploading file:",p)):(s=SUPABASE_URL+"/storage/v1/object/public/medicalrecords/"+u,l="Asia/Manila",c={patient_id:a,patient_name:e,created_date:(i=new Date).toLocaleString("en-US",{timeZone:l,year:"numeric"})+`-${i.toLocaleString("en-US",{timeZone:l,month:"2-digit"})}-`+i.toLocaleString("en-US",{timeZone:l,day:"2-digit"}),course_section:"Employee",location:o,added_by:r,med_file:s},{data:d,error:m}=await _supabase.from("med_forms").insert(c),m?(console.error("Error inserting data:",m.message),alert("Error inserting data:",m.message)):(console.log("Data inserted successfully:",d),loadTableData(),hidep(),shownotif(),$("#empname").val(""),$("#empid").val(""),$("#locsel1").val(""),$("#medform2").val("")))}catch(e){console.error("Error:",e.message),alert("Error:",e.message)}}),fetchUserPic(),fetchUsername();let filec,name1;function showv(e,t){var a=document.querySelector(".main2"),o=document.querySelector(".main"),r=document.querySelector(".vfile");r?((filec=document.createElement("embed")).classList.add("xfile"),filec.setAttribute("src",e),(name1=document.createElement("p")).id="dispname",name1.innerHTML=t,r.appendChild(filec),r.appendChild(name1)):console.error("Element with class 'vfile' not found."),o.classList.add("main-filter"),a.classList.add("showv"),a.classList.remove("hidev")}function hidev(){var e=document.querySelector(".main2"),t=document.querySelector(".main");const a=document.querySelector(".vfile");filec&&name1&&setTimeout(()=>{a.removeChild(filec),a.removeChild(name1)},500),t.classList.remove("main-filter"),e.classList.add("hidev"),e.classList.remove("showv")}async function displayResults(e){var{data:e,error:t}=await _supabase.from("med_forms").select("*").or(`patient_id.ilike.%${e}%, patient_name.ilike.%${e}%, course_section.ilike.%${e}%`);if(t)console.error("Error fetching patient data:",t.message),alert("Invalid Input");else{const a=document.querySelector("#medform_table tbody");a.innerHTML="",e&&0<e.length?e.forEach(e=>{var t=document.createElement("tr");t.classList.add("res1"),t.innerHTML=`
          <th class="row idcol">${e.patient_id}</th>
          <th class="row namecol">${e.patient_name}</th>
          <th class="row timecol">${e.created_date}</th>
          <th class="row coursecol">${e.course_section}</th>
          <th class="row timecol">${e.location}</th>
          <th class="row timecol">${e.added_by}</th>
          <th class="buttscol">
            <button class="viewbutt" onclick="showv('${e.med_file}', '${e.patient_name}')">
              <p class="txt">View</p>
            </button>
          </th>
        `,a.appendChild(t)}):((t=document.createElement("tr")).innerHTML=`
    <th class="row" colspan="7">Patient not found</td>
  `,a.appendChild(t))}}document.getElementById("searchInput").addEventListener("keyup",async function(){var e=this.value;e?displayResults(e):loadTableData()});